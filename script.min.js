var c=document.querySelector("canvas"),l=c.getContext("2d"),m=document.querySelector("p");document.getElementById("button");function p(a,b){this.x=void 0===a?0:a;this.y=void 0===b?0:b}function q(a){return Math.sqrt(a.x*a.x+a.y*a.y)}p.prototype.normalize=function(){var a=q(this);this.x/=a;this.y/=a};p.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};p.prototype.sub=function(a){return new p(this.x-a.x,this.y-a.y)};
function r(){var a=t.left+.02*(u+.5),b=t.bottom+.02*(v+.5);this.position=new p(void 0===a?0:a,void 0===b?0:b);this.s=new p;this.h=new p;this.force=new p;this.j=this.pressure=0}function x(a,b){for(var d=y,f=Math.floor((a.position.x-d.region.left)/d.g),h=Math.floor((a.position.y-d.region.bottom)/d.g),g=f-1;g<=f+1;g++)if(!(0>g||g>=d.o))for(var e=h-1;e<=h+1;e++)if(!(0>e||e>=d.u))for(var k=g+e*d.o,n=0,w=d.m[k].length;n<w;n++){var I=d.m[k][n],J=a.position.sub(I.position);q(J)>=d.g||b(I,J)}}
function z(){var a=A;this.g=.03;this.o=Math.ceil(a.width/this.g);this.u=Math.ceil(a.height/this.g);this.m=Array(this.o*this.u);this.region=a}z.prototype.clear=function(){for(var a=0,b=this.m.length;a<b;a++)this.m[a]=[]};z.prototype.add=function(a){for(var b=0,d=a.length;b<d;b++){var f=a[b];this.m[Math.floor((f.position.x-this.region.left)/this.g)+Math.floor((f.position.y-this.region.bottom)/this.g)*this.o].push(a[b])}};
function B(a,b){this.width=a;this.height=b;this.left=0;this.right=0+a;this.bottom=0;this.top=0+b}var C=new Stats;C.showPanel(0);document.body.appendChild(C.dom);for(var D=new function(){this.g=.03;this.alpha=4/(Math.PI*Math.pow(.03,8))},E=new p(0,-9.8),A=new B(1,1),y=new z,F=8*y.g,G=F*F,H=[],t=new B(.5,.8),K=Math.round(t.width/.02),L=Math.round(t.height/.02),u=0;u<K;u++)for(var v=0;v<L;v++)H.push(new r);
var M=Math.min(window.innerWidth,window.innerHeight),N=(Math.max(window.innerWidth,window.innerHeight)-M)/2/M,O=0,P=0,Q=!1;m.innerHTML="particleSize : 0.02<br>particleNum : "+H.length+"<br>canvasSize : 512<br>timeStepLength : 0.0025<br>iterationNum : 4<br>restDensity : 1000<br>viscosity : 4<br>massParticle : 0.4<br>gravity : Vec2(x : "+E.x+", y : "+E.y+")";c.addEventListener("mousedown",function(a){a.preventDefault();R(a)});
c.addEventListener("mousemove",function(a){a.preventDefault();O=a.pageX/M-N;P=1-a.pageY/M});c.addEventListener("mouseup",function(a){a.preventDefault();Q=!1});c.addEventListener("touchstart",function(a){a.preventDefault();R(a.changedTouches[0])});c.addEventListener("touchmove",function(a){a.preventDefault();a=a.changedTouches[0];O=a.pageX/M-N;P=1-a.pageY/M});c.addEventListener("touchend",function(a){a.preventDefault();Q=!1});function R(a){O=a.pageX/M-N;P=1-a.pageY/M;Q=!0}
function S(){(function(a){for(var b={},d=0,f=a.length;d<f;b={j:b.j},d++)b.j=0,x(a[d],function(h){return function(g,e){var k=q(e);h.j+=.4*(k<D.g?D.alpha*Math.pow(D.g*D.g-k*k,3):0)}}(b)),a[d].j=b.j,a[d].pressure=Math.max(100*(a[d].j-1E3),0)})(H)}
function T(){for(var a={l:0},b=H.length;a.l<b;a={l:a.l,i:a.i},a.l++)a.i=new p,x(H[a.l],function(d){return function(f,h){if(H[d.l]!==f){var g=q(h);var e=q(h);e<D.g?(e=-6*D.alpha*Math.pow(D.g*D.g-e*e,2),e=new p(e*h.x,e*h.y)):e=new p;var k=-.4*(f.pressure/(f.j*f.j)+H[d.l].pressure/(H[d.l].j*H[d.l].j));d.i.x+=e.x*k;d.i.y+=e.y*k;k=g*g+3E-4*.03;g=H[d.l].s.sub(f.s);e=3.2/(f.j*H[d.l].j)*(h.x*e.x+h.y*e.y)/k;d.i.x+=e*g.x;d.i.y+=e*g.y}}}(a)),a.i.x+=E.x,a.i.y+=E.y,H[a.l].force.x=a.i.x,H[a.l].force.y=a.i.y}
function U(){l.clearRect(0,0,c.width,c.height);for(var a=512/A.width,b=0,d=H.length;b<d;b++){var f=.02*a/4,h=(H[b].position.x-A.left)*a,g=512-(H[b].position.y-A.bottom)*a;l.beginPath();l.arc(h,g,f,0,2*Math.PI);l.fill();l.closePath()}}
function V(){C.begin();for(var a=0;4>a;a++){y.clear();y.add(H);S();T();for(var b=0,d=H.length;b<d;b++)H[b].h.x+=.0025*H[b].force.x,H[b].h.y+=.0025*H[b].force.y,H[b].position.x+=.0025*H[b].h.x,H[b].position.y+=.0025*H[b].h.y,H[b].position.y-.02<A.bottom&&(H[b].position.y=.02,H[b].h.y*=-1,H[b].force.y*=-1),H[b].position.y+.02>A.top&&(H[b].position.y=.98,H[b].h.y*=-1,H[b].force.y*=-1),H[b].position.x-.02<A.left&&(H[b].position.x=.02,H[b].h.x*=-1,H[b].force.x*=-1),H[b].position.x+.02>A.right&&(H[b].position.x=
.98,H[b].h.x*=-1,H[b].force.x*=-1),H[b].s.x=H[b].h.x+.00125*H[b].force.x,H[b].s.y=H[b].h.y+.00125*H[b].force.y}if(Q)for(a=Math.floor((O-y.region.left)/y.g),b=Math.floor((P-y.region.bottom)/y.g),d=a-8;d<=a+8;d++)if(!(0>d||d>=y.o))for(var f=b-8;f<=b+8;f++)if(!(0>f||f>=y.u))for(var h=d+f*y.o,g=0,e=y.m[h].length;g<e;g++){var k=y.m[h][g],n=O-k.position.x,w=P-k.position.y;n*n+w*w>G||(n=new p(n,w),n.x*=2,n.y*=2,k.h.add(n))}U();C.end();requestAnimationFrame(V)}c.width=512;c.height=512;l.fillStyle="blue";
U();V();
