var c=document.querySelector("canvas"),l=c.getContext("2d"),m=document.querySelector("p");document.getElementById("button");function p(a,b){this.x=void 0===a?0:a;this.y=void 0===b?0:b}function q(a){return Math.sqrt(a.x*a.x+a.y*a.y)}p.prototype.normalize=function(){var a=q(this);this.x/=a;this.y/=a};p.prototype.a=function(a){this.x+=a.x;this.y+=a.y;return this};p.prototype.s=function(a){return new p(this.x-a.x,this.y-a.y)};function r(){var a=t.l+.02*(u+.5),b=t.b+.02*(v+.5);this.p=new p(void 0===a?0:a,void 0===b?0:b);this.s=new p;this.h=new p;this.f=new p;this.j=this.i=0;this.a=!0}r.prototype.remove=function(){this.a=!1};function w(a,b){for(var d=y,e=Math.floor((a.p.x-d.r.l)/d.g),k=Math.floor((a.p.y-d.r.b)/d.g),g=e-1;g<=e+1;g++)if(!(0>g||g>=d.o))for(var f=k-1;f<=k+1;f++)if(!(0>f||f>=d.u))for(var n=g+f*d.o,h=0,x=d.m[n].length;h<x;h++){var M=d.m[n][h],N=a.p.s(M.p);q(N)>=d.g||b(M,N)}}function z(){var a=A;this.g=.03;this.o=Math.ceil(a.w/this.g);this.u=Math.ceil(a.h/this.g);this.m=Array(this.o*this.u);this.r=a}z.prototype.c=function(){for(var a=0,b=this.m.length;a<b;a++)this.m[a]=[]};z.prototype.a=function(a){for(var b=0,d=a.length;b<d;b++)if(a[b].a){var e=a[b];this.m[Math.floor((e.p.x-this.r.l)/this.g)+Math.floor((e.p.y-this.r.b)/this.g)*this.o].push(a[b])}};function B(a,b,d,e){this.w=d;this.h=e;this.l=a;this.right=a+d;this.b=b;this.t=b+e}var C=new Stats;C.showPanel(0);document.body.appendChild(C.dom);for(var D=new function(){this.g=.03;this.a=4/(Math.PI*Math.pow(.03,8))},E=new p(0,-9.8),A=new B(0,0,1,1),y=new z,F=.02*.13,G=4*y.g,H=G*G,I=[],t=new B(.02,.02,.4,.8),J=Math.round(t.w/.02),K=Math.round(t.h/.02),u=0;u<J;u++)for(var v=0;v<K;v++)I.push(new r);var L=[],O=Math.min(window.innerWidth,window.innerHeight),P=(Math.max(window.innerWidth,window.innerHeight)-O)/2/O,Q=!1,R=0,S=0,T=!1;c.addEventListener("mousedown",function(a){a.preventDefault();U(a)});c.addEventListener("mousemove",function(a){a.preventDefault();R=a.pageX/O-P;S=1-a.pageY/O});c.addEventListener("mouseup",function(a){a.preventDefault();T=!1});c.addEventListener("touchstart",function(a){a.preventDefault();U(a.changedTouches[0])});c.addEventListener("touchmove",function(a){a.preventDefault();a=a.changedTouches[0];R=a.pageX/O-P;S=1-a.pageY/O});c.addEventListener("touchend",function(a){a.preventDefault();T=!1});function U(a){R=a.pageX/O-P;S=1-a.pageY/O;T=!0}function V(){function a(b){for(var d={},e=0,k=b.length;e<k;d={j:d.j},e++)b[e].a&&(d.j=0,w(b[e],function(g){return function(f,n){var h=q(n);g.j+=.4*(h<D.g?D.a*Math.pow(D.g*D.g-h*h,3):0)}}(d)),b[e].j=d.j,b[e].i=Math.max(100*(b[e].j-1E3),0))}a(I);a(L)}function W(){for(var a={l:0},b=I.length;a.l<b;a={l:a.l,i:a.i},a.l++)I[a.l].a&&(a.i=new p,w(I[a.l],function(d){return function(e,k){if(I[d.l]!==e){var g=q(k);var f=q(k);f<D.g?(f=-6*D.a*Math.pow(D.g*D.g-f*f,2),f=new p(f*k.x,f*k.y)):f=new p;var n=-.4*(e.i/(e.j*e.j)+I[d.l].i/(I[d.l].j*I[d.l].j));d.i.x+=f.x*n;d.i.y+=f.y*n;n=g*g+3E-4*.03;g=I[d.l].s.s(e.s);f=3.2/(e.j*I[d.l].j)*(k.x*f.x+k.y*f.y)/n;d.i.x+=f*g.x;d.i.y+=f*g.y}}}(a)),a.i.x+=E.x,a.i.y+=E.y,I[a.l].f.x=a.i.x,I[a.l].f.y=a.i.y)}function X(){l.clearRect(0,0,c.width,c.height);for(var a=512/A.w,b=0,d=I.length;b<d;b++)if(I[b].a){var e=(I[b].p.x-A.l)*a,k=512-(I[b].p.y-A.b)*a;l.fillStyle="hsl("+(I[b].i/50+220)+", 100%, 50%)";l.beginPath();l.arc(e,k,.02*a/2,0,2*Math.PI);l.fill();l.closePath()}}function Y(){if(Q){C.begin();for(var a=0;4>a;a++){y.c();y.a(I);y.a(L);V();W();for(var b=0,d=I.length;b<d;b++)I[b].a&&(I[b].h.x+=I[b].f.x*F,I[b].h.y+=I[b].f.y*F,I[b].p.x+=I[b].h.x*F,I[b].p.y+=I[b].h.y*F,I[b].p.y-.02<A.b&&(I[b].p.y=.02,I[b].h.y*=-1,I[b].f.y*=-1),I[b].p.y+.02>A.t&&(I[b].p.y=.98,I[b].h.y*=-1,I[b].f.y*=-1),I[b].p.x-.02<A.l&&(I[b].p.x=.02,I[b].h.x*=-1,I[b].f.x*=-1),I[b].p.x+.02>A.right&&(I[b].p.x=.98,I[b].h.x*=-1,I[b].f.x*=-1),I[b].s.x=I[b].h.x+.5*I[b].f.x*F,I[b].s.y=I[b].h.y+.5*I[b].f.y*F)}if(T)for(a=Math.floor((R-y.r.l)/y.g),b=Math.floor((S-y.r.b)/y.g),d=a-4;d<=a+4;d++)if(!(0>d||d>=y.o))for(var e=b-4;e<=b+4;e++)if(!(0>e||e>=y.u))for(var k=d+e*y.o,g=0,f=y.m[k].length;g<f;g++){var n=y.m[k][g],h=R-n.p.x,x=S-n.p.y;h*h+x*x>H||(h=new p(h,x),h.x*=4,h.y*=4,n.h.a(h))}X();C.end()}requestAnimationFrame(Y)}c.width=512;c.height=512;Q=!1;l.fillStyle="blue";X();Q=!Q;Y();m.innerHTML="particleSize : 0.02<br>particleNum : "+(I.length+L.length)+"<br>canvasSize : 512<br>timeStepLength : "+F+"<br>iterationNum : 4<br>restDensity : 1000<br>viscosity : 4<br>massParticle : 0.4<br>gravity : Vec2(x : "+E.x+", y : "+E.y+")";
