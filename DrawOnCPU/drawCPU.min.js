var c=document.querySelector("canvas"),k=c.getContext("2d"),m=document.querySelector("p");document.getElementById("button");function n(a,b){this.x=void 0===a?0:a;this.y=void 0===b?0:b}function p(a){return Math.sqrt(a.x*a.x+a.y*a.y)}n.prototype.normalize=function(){var a=p(this);this.x/=a;this.y/=a};n.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};n.prototype.sub=function(a){return new n(this.x-a.x,this.y-a.y)};
function t(){var a=u.left+.02*(v+.5),b=u.bottom+.02*(w+.5);this.position=new n(void 0===a?0:a,void 0===b?0:b);this.s=new n;this.l=new n;this.force=new n;this.i=this.pressure=0}function x(a,b){for(var d=y,f=Math.floor((a.position.x-d.region.left)/d.g),h=Math.floor((a.position.y-d.region.bottom)/d.g),g=f-1;g<=f+1;g++)if(!(0>g||g>=d.o))for(var e=h-1;e<=h+1;e++)if(!(0>e||e>=d.u))for(var l=g+e*d.o,q=0,r=d.m[l].length;q<r;q++){var J=d.m[l][q],K=a.position.sub(J.position);p(K)>=d.g||b(J,K)}}
function z(){var a=A;this.g=.03;this.o=Math.ceil(a.width/this.g);this.u=Math.ceil(a.height/this.g);this.m=Array(this.o*this.u);this.region=a}z.prototype.clear=function(){for(var a=0,b=this.m.length;a<b;a++)this.m[a]=[]};z.prototype.add=function(a){for(var b=0,d=a.length;b<d;b++){var f=a[b];this.m[Math.floor((f.position.x-this.region.left)/this.g)+Math.floor((f.position.y-this.region.bottom)/this.g)*this.o].push(a[b])}};
function B(a,b){this.width=a;this.height=b;this.left=0;this.right=0+a;this.bottom=0;this.top=0+b}var C=new Stats;C.showPanel(0);document.body.appendChild(C.dom);c.width=512;c.height=512;for(var D=Math.min(window.innerWidth,window.innerHeight),E=(Math.max(window.innerWidth,window.innerHeight)-D)/2/D,F=new function(){this.g=.03;this.alpha=4/(Math.PI*Math.pow(.03,8))},G=new n(0,-9.8),A=new B(1,1),y=new z,H=6*y.g*c.height,I=6*y.g,L=I*I,M=[],u=new B(.5,.8),N=Math.round(u.width/.02),O=Math.round(u.height/.02),v=0;v<N;v++)for(var w=0;w<O;w++)M.push(new t);var P=1,Q=0,R=0,S=!1;
c.addEventListener("mousedown",function(a){a.preventDefault();T(a)});c.addEventListener("mousemove",function(a){a.preventDefault();Q=a.pageX/D-E;R=1-a.pageY/D});c.addEventListener("mouseup",function(a){a.preventDefault();S=!1});
c.addEventListener("touchstart",function(a){a.preventDefault();T(a.changedTouches[0])});c.addEventListener("touchmove",function(a){a.preventDefault();a=a.changedTouches[0];Q=a.pageX/D-E;R=1-a.pageY/D});c.addEventListener("touchend",function(a){a.preventDefault();S=!1});c.addEventListener("contextmenu",function(a){a.preventDefault();P=-P});function T(a){Q=a.pageX/D-E;R=1-a.pageY/D;S=!0}
function U(){(function(a){for(var b={},d=0,f=a.length;d<f;b={i:b.i},d++)b.i=0,x(a[d],function(h){return function(g,e){var l=p(e);h.i+=.4*(l<F.g?F.alpha*Math.pow(F.g*F.g-l*l,3):0)}}(b)),a[d].i=b.i,a[d].pressure=Math.max(100*(a[d].i-1E3),0)})(M)}function V(){for(var a={j:0},b=M.length;a.j<b;a={j:a.j,h:a.h},a.j++)a.h=new n,x(M[a.j],function(d){return function(f,h){if(M[d.j]!==f){var g=p(h);var e=p(h);e<F.g?(e=-6*F.alpha*Math.pow(F.g*F.g-e*e,2),e=new n(e*h.x,e*h.y)):e=new n;var l=-.4*(f.pressure/(f.i*f.i)+M[d.j].pressure/(M[d.j].i*M[d.j].i));d.h.x+=e.x*l;d.h.y+=e.y*l;l=g*g+3E-4*.03;g=M[d.j].s.sub(f.s);e=3.2/(f.i*M[d.j].i)*(h.x*e.x+h.y*e.y)/l;d.h.x+=e*g.x;d.h.y+=e*g.y}}}(a)),a.h.x+=G.x,a.h.y+=G.y,M[a.j].force.x=a.h.x,M[a.j].force.y=a.h.y}
function W(){C.begin();k.clearRect(0,0,c.width,c.height);for(var a=0;4>a;a++){y.clear();y.add(M);U();V();for(var b=0,d=M.length;b<d;b++){M[b].l.x+=.0025*M[b].force.x;M[b].l.y+=.0025*M[b].force.y;M[b].position.x+=.0025*M[b].l.x;M[b].position.y+=.0025*M[b].l.y;if(.02>M[b].position.y||.98<M[b].position.y)M[b].l.y=-M[b].l.y;if(.02>M[b].position.x||.98<M[b].position.x)M[b].l.x=-M[b].l.x;M[b].position.x=Math.min(.98,Math.max(M[b].position.x,.02));M[b].position.y=Math.min(.98,Math.max(M[b].position.y,.02));
M[b].s.x=M[b].l.x+.00125*M[b].force.x;M[b].s.y=M[b].l.y+.00125*M[b].force.y}}if(S){a=Math.floor((Q-y.region.left)/y.g);b=Math.floor((R-y.region.bottom)/y.g);for(d=a-6;d<=a+6;d++)if(!(0>d||d>=y.o))for(var f=b-6;f<=b+6;f++)if(!(0>f||f>=y.u))for(var h=d+f*y.o,g=0,e=y.m[h].length;g<e;g++){var l=y.m[h][g],q=Q-l.position.x,r=R-l.position.y;q*q+r*r>L||(q=new n(q,r),r=2*P,q.x*=r,q.y*=r,l.l.add(q))}k.beginPath();k.strokeStyle=1==P?"#22BC46":"#B92121";k.lineWidth=1;k.arc(Q*c.width,c.height*(1-R),H,0,2*Math.PI);
k.stroke();k.closePath()}a=512/A.width;k.fillStyle="#00FFFF";b=0;for(d=M.length;b<d;b++)f=.02*a/4,h=(M[b].position.x-A.left)*a,g=512-(M[b].position.y-A.bottom)*a,k.fillStyle="hsl("+(220-M[b].pressure/100)+", 80%, 40%)",k.beginPath(),k.arc(h,g,f,0,2*Math.PI),k.fill(),k.closePath();C.end();requestAnimationFrame(W)}k.fillStyle="blue";W();
